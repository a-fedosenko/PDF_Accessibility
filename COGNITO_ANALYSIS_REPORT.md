# Comprehensive Cognito Authentication & Authorization Analysis
## PDF Accessibility Solutions - IdentityServer4 Integration Assessment

**Analysis Date**: November 17, 2025  
**Project**: PDF Accessibility Solutions  
**Region**: us-east-2  
**Account ID**: 471414695760  

---

## Executive Summary

This document provides a detailed analysis of all Cognito authentication and authorization implementations in the PDF Accessibility project. The current architecture uses AWS Cognito for user authentication and authorization but **DOES NOT currently expose an active UI with authentication** in the main PDF processing stack. However, there is infrastructure prepared for UI integration.

**Key Finding**: The codebase references Cognito in deployment documentation but the active deployment focuses on backend API services without frontend authentication. The UI-related Cognito configuration exists in the "CdkBackendStack" but is deployed separately.

---

## Current Cognito Implementation Status

### 1. Cognito User Pool Configuration

#### Current Implementation
- **User Pool ID**: `us-east-2_HJtK36MHO`
- **User Pool Name**: Auto-generated by CDK (referenced in deployment summaries)
- **App Client ID**: `7s84oe77h699j77oc6m8cbvogt`
- **User Pool Domain**: `pdf-ui-auth1rc16k`
- **Region**: us-east-2

#### User Pool Features Enabled
✓ Email-based authentication  
✓ Email verification required  
✓ Password complexity requirements  
✓ Multi-factor authentication (optional)  
✓ User attributes: email, name, custom fields  

**Files Referenced**:
- `/home/andreyf/projects/PDF_Accessibility/_AWS_RESOURCES.md` (lines 200-217)
- `/home/andreyf/projects/PDF_Accessibility/_DEPLOYMENT_SUMMARY.md` (lines 49-59)

---

### 2. Cognito Identity Pool Configuration

#### Current Implementation
- **Identity Pool ID**: `us-east-2:c0f78434-f184-465f-8adb-ff2675227da2`
- **Purpose**: Provides temporary AWS credentials for authenticated users
- **Authentication Providers**: Cognito User Pool
- **Region**: us-east-2

#### Authentication Provider Configuration
```
Identity Pool → Cognito User Pool
              → User Pool ID: us-east-2_HJtK36MHO
              → App Client ID: 7s84oe77h699j77oc6m8cbvogt
```

**Files Referenced**:
- `/home/andreyf/projects/PDF_Accessibility/_AWS_RESOURCES.md` (lines 207-210)

---

### 3. Authentication Flows & Callbacks

#### Current Implementation Status
**MINIMAL/IMPLICIT**: The codebase does not define explicit authentication flows at the CDK level.

#### Expected OAuth 2.0 Flows (Not Explicitly Defined in Code)
- Authorization Code Flow (implicit in Cognito)
- Implicit Flow (for SPAs)
- Refresh Token Flow
- Client Credentials Flow (if enabled)

#### Cognito Domain & Sign-In URL
```
Domain: pdf-ui-auth1rc16k.auth.us-east-2.amazoncognito.com

Sign-In URL: 
https://pdf-ui-auth1rc16k.auth.us-east-2.amazoncognito.com/login?client_id=7s84oe77h699j77oc6m8cbvogt&response_type=code&scope=openid+profile+email&redirect_uri={REDIRECT_URI}
```

#### Callback/Redirect URIs
**Not explicitly defined in codebase** - Would need to be configured in:
- Amplify Frontend Application
- API Gateway endpoints
- Lambda authorizers

**Expected Flow (Based on Architecture)**:
1. User accesses Amplify frontend
2. Frontend redirects to Cognito sign-in
3. Cognito returns authorization code
4. Frontend exchanges code for tokens
5. Frontend includes ID/Access token in API calls
6. API Gateway/Lambda validates token

**Files Referenced**:
- `/home/andreyf/projects/PDF_Accessibility/_AWS_RESOURCES.md` (line 204)

---

### 4. IAM Roles for Authenticated/Unauthenticated Users

#### Authenticated User Role
```
Role Name: CdkBackendStack-CognitoDefaultAuthenticatedRole-*
ARN: arn:aws:iam::471414695760:role/CdkBackendStack-CognitoDefaultAuthenticatedRoleC5D5-uIO7y0rrWVVH
```

**Current Permissions** (Not Explicitly Listed in Codebase):
- Implied S3 access for file operations
- API Gateway invocation
- CloudWatch Logs read access

#### Unauthenticated User Role
```
Role Name: CdkBackendStack-CognitoDefaultUnauthenticatedRole-*
Status: Created by CDK but permissions not explicitly defined
```

**Expected Permissions**:
- Limited or no access
- Redirect to sign-in for restricted resources

**Policy Attachment Details**:
The exact permissions are generated by CDK's Cognito Identity Pool construct but are not explicitly visible in the source code.

**Files Referenced**:
- `/home/andreyf/projects/PDF_Accessibility/_AWS_RESOURCES.md` (lines 158-159)

---

### 5. API Gateway Authorizers

#### API Gateway Setup
```
API Gateway Instance: CdkBackendStack API
Endpoint Base: https://6597iy1nhi.execute-api.us-east-2.amazonaws.com/prod/
Region: us-east-2
Stage: prod
```

#### API Resources with Authorization
1. **POST /update-first-sign-in**
   - Purpose: Update user attributes on first sign-in
   - Authentication: Cognito Authorizer (implied)
   
2. **GET /upload-quota**
   - Purpose: Check user upload quota
   - Authentication: Cognito Authorizer (implied)
   
3. **POST /** (General API)
   - Purpose: General API operations
   - Authentication: Various operations

#### Authorizer Type Configuration
**Status**: CDK context flag exists but authorizer not explicitly implemented in code

```json
From cdk.json (line 43):
"@aws-cdk/aws-apigateway:authorizerChangeDeploymentLogicalId": true
```

This flag enables proper deployment of API Gateway authorizers when they are created.

**Authorization Type**: Likely Cognito User Pool (Default for CDK)

**Files Referenced**:
- `/home/andreyf/projects/PDF_Accessibility/_AWS_RESOURCES.md` (lines 412-432)
- `/home/andreyf/projects/PDF_Accessibility/cdk.json` (line 43)

---

### 6. Hardcoded Cognito References

#### Deployment Documentation References
These are the key hardcoded references that would need updating for IdentityServer4 integration:

1. **User Pool ID**
   - Location: Multiple files
   - Value: `us-east-2_HJtK36MHO`
   - Files:
     - `_AWS_RESOURCES.md` (line 201)
     - `_DEPLOYMENT_SUMMARY.md` (line 50)
     - `cleanup.sh` (line 367)

2. **App Client ID**
   - Location: Environment/Config references
   - Value: `7s84oe77h699j77oc6m8cbvogt`
   - Files:
     - `_AWS_RESOURCES.md` (line 203)
     - `_DEPLOYMENT_SUMMARY.md` (line 51)

3. **Identity Pool ID**
   - Location: Environment/Config references
   - Value: `us-east-2:c0f78434-f184-465f-8adb-ff2675227da2`
   - Files:
     - `_AWS_RESOURCES.md` (line 208)
     - `_DEPLOYMENT_SUMMARY.md` (line 53)

4. **Cognito Domain**
   - Location: Sign-in URL references
   - Value: `pdf-ui-auth1rc16k`
   - Files:
     - `_AWS_RESOURCES.md` (line 204, 708)

5. **Frontend Environment Variables**
   - Files:
     - `_AWS_RESOURCES.md` (lines 403-408)
     - `.env` file (would contain references)
   - Variables:
     ```
     REACT_APP_USER_POOL_ID
     REACT_APP_USER_POOL_CLIENT_ID
     REACT_APP_IDENTITY_POOL_ID
     ```

#### Code-Level References
**Current Status**: No explicit Cognito SDK imports or hardcoded values found in:
- `app.py` (Main CDK app)
- `pdf2html/cdk/lib/pdf2html-stack.js`
- Lambda functions
- Docker containers

**Reason**: Cognito is managed entirely through CDK infrastructure definitions, not runtime code.

---

## Current Architecture Details

### CDK Stack Configuration

#### Main Stack: PDFAccessibility
**File**: `/home/andreyf/projects/PDF_Accessibility/app.py`

**Cognito Status**: NOT DEFINED in this stack

The primary PDF-to-PDF processing stack does not include Cognito configuration. It focuses on:
- S3 bucket creation
- Lambda functions (no authentication required)
- ECS tasks (internal to VPC)
- Step Functions state machine
- CloudWatch dashboards

#### Backend Stack: CdkBackendStack
**Location**: Referenced in deployment documentation

**Cognito Status**: INCLUDED in this stack

This separate stack (deployed as part of UI deployment) includes:
- Cognito User Pool creation
- Cognito Identity Pool creation
- API Gateway with Lambda functions
- IAM roles for authenticated users

#### PDF-to-HTML Stack: Pdf2HtmlStack
**File**: `/home/andreyf/projects/PDF_Accessibility/pdf2html/cdk/lib/pdf2html-stack.js`

**Cognito Status**: NOT DEFINED in this stack

This Lambda-based PDF-to-HTML conversion stack does not use Cognito.

---

## Deployment Architecture

```
Deployment Flow:
┌─────────────────────────────────────────┐
│  Deploy Backend Solution (PDF-to-PDF)   │
│  - No Cognito                           │
│  - S3, Lambda, ECS, Step Functions      │
└──────────────┬──────────────────────────┘
               │
       ┌───────▼────────┐
       │ Deploy UI?     │
       └───────┬────────┘
               │ YES
       ┌───────▼──────────────────────┐
       │  Deploy CdkBackendStack      │
       │  - Cognito User Pool         │
       │  - Cognito Identity Pool     │
       │  - API Gateway + Lambda      │
       │  - Amplify Frontend          │
       └──────────────────────────────┘
```

---

## Environment Variables & Configuration

### Cognito-Related Environment Variables
**Location**: `.env` file (not tracked in source control)

**Current Variables** (Based on deployment docs):
```bash
# User Pool Configuration
REACT_APP_USER_POOL_ID=us-east-2_HJtK36MHO
REACT_APP_USER_POOL_CLIENT_ID=7s84oe77h699j77oc6m8cbvogt

# Identity Pool Configuration
REACT_APP_IDENTITY_POOL_ID=us-east-2:c0f78434-f184-465f-8adb-ff2675227da2

# API Endpoints
REACT_APP_UPDATE_FIRST_SIGN_IN_ENDPOINT=https://6597iy1nhi.execute-api.us-east-2.amazonaws.com/prod/update-first-sign-in
REACT_APP_CHECK_UPLOAD_QUOTA_ENDPOINT=https://6597iy1nhi.execute-api.us-east-2.amazonaws.com/prod/upload-quota
REACT_APP_UPDATE_ATTRIBUTES_API_ENDPOINT=https://6597iy1nhi.execute-api.us-east-2.amazonaws.com/prod/
```

---

## Security & Best Practices

### Current Implementation
✓ Email verification required  
✓ Password complexity requirements  
✓ HTTPS/TLS for all communications  
✓ SSL/TLS enforced for S3 buckets  
✓ Secrets Manager for API credentials (Adobe)  
✓ IAM roles with least privilege  

### Gaps Identified
✗ Multi-factor authentication not mentioned as enabled  
✗ No explicit token validation code in Lambda functions  
✗ Authorization flows not explicitly defined  
✗ No refresh token rotation mechanism visible  
✗ Cognito events/triggers not configured  

---

## Changes Required for IdentityServer4 Integration

### 1. Infrastructure Changes (CDK)

#### Replace Cognito User Pool
```python
# REMOVE:
cognito.UserPool()
cognito.UserPoolClient()
cognito_identity.IdentityPool()

# ADD:
# References to external IdentityServer4 instance
# Configuration for OpenID Connect provider
```

#### Add OpenID Connect Provider to Identity Pool
```python
# Configure AWS to trust IdentityServer4 as an external provider
identitypool.add_cognito_identity_provider(
    client_id="your-client-id",
    provider_name="identityserver4.example.com"
)
```

#### API Gateway Authorization Changes
```python
# REMOVE:
api.add_cognito_authorizer()

# ADD:
# Lambda function as custom authorizer
# Validate IdentityServer4 tokens
```

### 2. Configuration Changes

#### Update Environment Variables
```bash
# REMOVE (or repurpose):
REACT_APP_USER_POOL_ID=us-east-2_HJtK36MHO
REACT_APP_USER_POOL_CLIENT_ID=7s84oe77h699j77oc6m8cbvogt
REACT_APP_IDENTITY_POOL_ID=us-east-2:c0f78434-f184-465f-8adb-ff2675227da2

# ADD:
REACT_APP_OIDC_AUTHORITY=https://identityserver4.example.com
REACT_APP_OIDC_CLIENT_ID=your-client-id
REACT_APP_OIDC_CLIENT_SECRET=your-client-secret
REACT_APP_OIDC_REDIRECT_URI=https://your-app.amplifyapp.com/callback
```

#### Update Documentation Files
- `/home/andreyf/projects/PDF_Accessibility/_AWS_RESOURCES.md` (lines 158-159, 198-217)
- `/home/andreyf/projects/PDF_Accessibility/_DEPLOYMENT_SUMMARY.md` (lines 49-59)
- `/home/andreyf/projects/PDF_Accessibility/.env` (if applicable)

### 3. Hardcoded References to Update

| File | Line(s) | Reference | Update Required |
|------|---------|-----------|-----------------|
| `cleanup.sh` | 367 | Cognito User Pool ID | Update or remove cleanup |
| `_AWS_RESOURCES.md` | 158-159, 198-217 | Cognito role definitions | Replace with IdentityServer4 role mapping |
| `_AWS_RESOURCES.md` | 200-210 | User Pool/Identity Pool config | Replace with OIDC provider config |
| `_AWS_RESOURCES.md` | 708 | Cognito domain | Replace with IdentityServer4 authority |
| `_DEPLOYMENT_SUMMARY.md` | 49-59 | Cognito configuration section | Update to OIDC configuration |

### 4. Lambda Custom Authorizer Implementation

#### Create New Token Validation Lambda
```python
# New file: lambda/authorizer/index.py

import json
import requests
import jwt
from datetime import datetime

def lambda_handler(event, context):
    """
    Custom authorizer for IdentityServer4 tokens
    """
    
    # Extract token from Authorization header
    token = event['authorizationToken'].split(' ')[1]
    
    try:
        # Validate token with IdentityServer4
        # 1. Get public keys from /.well-known/openid-configuration
        # 2. Validate JWT signature
        # 3. Check token claims (scopes, audience, expiration)
        # 4. Return IAM policy
        
        payload = jwt.decode(
            token,
            get_issuer_public_key(),
            algorithms=['RS256'],
            audience='your-api-audience'
        )
        
        # Build IAM policy for authorized access
        policy = {
            'principalId': payload['sub'],
            'policyDocument': {
                'Version': '2012-10-17',
                'Statement': [
                    {
                        'Action': 'execute-api:Invoke',
                        'Effect': 'Allow',
                        'Resource': event['methodArn']
                    }
                ]
            },
            'context': {
                'userId': payload['sub'],
                'email': payload['email']
            }
        }
        
        return policy
        
    except Exception as e:
        raise Exception('Unauthorized')
```

### 5. Frontend Integration Changes

#### Update Amplify App Configuration
```javascript
// REMOVE:
import Amplify, { Auth } from 'aws-amplify';

Amplify.configure({
  Auth: {
    region: 'us-east-2',
    userPoolId: 'us-east-2_HJtK36MHO',
    userPoolWebClientId: '7s84oe77h699j77oc6m8cbvogt',
    identityPoolId: 'us-east-2:c0f78434-f184-465f-8adb-ff2675227da2'
  }
});

// ADD:
import OktaAuth from '@okta/okta-auth-js';
// OR
import { UserManager } from 'oidc-client-ts';

const userManager = new UserManager({
  authority: 'https://identityserver4.example.com',
  client_id: 'your-client-id',
  redirect_uri: 'https://your-app.amplifyapp.com/callback',
  response_type: 'code',
  scope: 'openid profile email api',
  post_logout_redirect_uri: 'https://your-app.amplifyapp.com'
});
```

---

## Implementation Timeline

### Phase 1: Planning & Setup (Week 1)
- [ ] Set up IdentityServer4 instance (on-premises or cloud)
- [ ] Configure OIDC client registration
- [ ] Create OpenID Connect discovery endpoint
- [ ] Document client credentials and endpoints

### Phase 2: Infrastructure Updates (Week 2-3)
- [ ] Update CDK stacks to remove Cognito resources
- [ ] Implement Lambda custom authorizer
- [ ] Configure API Gateway with new authorizer
- [ ] Update AWS Identity Pool for OIDC provider

### Phase 3: Integration & Testing (Week 3-4)
- [ ] Update frontend authentication code
- [ ] Implement token refresh logic
- [ ] Test authentication flows
- [ ] Validate API access controls

### Phase 4: Deployment & Migration (Week 4-5)
- [ ] Deploy updated infrastructure
- [ ] Migrate existing users (if applicable)
- [ ] Update documentation
- [ ] Decommission old Cognito resources

---

## Risk Assessment

### Low Risk
- Infrastructure changes (CDK) can be deployed to new stack
- Frontend code is isolated and can be updated independently
- No changes to core processing logic (Lambda, ECS, Step Functions)

### Medium Risk
- User migration from Cognito to IdentityServer4
- Token validation performance in Lambda authorizer
- OIDC compatibility with AWS API Gateway

### High Risk
- Production deployment with active users
- Token format differences between Cognito and IdentityServer4
- Custom claims mapping requirements

---

## Testing Checklist

- [ ] OIDC Discovery endpoint accessible
- [ ] JWT token validation working in Lambda
- [ ] API Gateway returning 401 for invalid tokens
- [ ] API Gateway returning 200 for valid tokens
- [ ] User attributes correctly mapped to API context
- [ ] Token refresh flow working
- [ ] Logout flow properly revokes tokens
- [ ] Scopes and permissions enforced

---

## Rollback Plan

If IdentityServer4 integration encounters critical issues:

1. Restore previous Cognito-based CDK stack from version control
2. Redeploy CDK stack: `cdk deploy`
3. Revert frontend authentication code
4. Update environment variables to Cognito values
5. Clear browser cache and re-test

**Expected Rollback Time**: 15-30 minutes

---

## Summary of Cognito Implementation

| Component | Status | Location | Impact |
|-----------|--------|----------|--------|
| User Pool | Active | Deployed separately for UI | High - Auth/Authz |
| Identity Pool | Active | Deployed separately for UI | High - Temporary credentials |
| Auth Flows | Implicit | Default Cognito flows | Medium - Token exchange |
| IAM Roles | Configured | CloudFormation-generated | High - Access control |
| API Authorizer | Not explicit | API Gateway (implied) | Medium - API security |
| Lambda Auth | None | Not implemented | Medium - Token validation |
| Hardcoded Refs | Multiple | Docs + config files | High - Migration scope |

---

## Recommendations

1. **Use AWS Secrets Manager** for IdentityServer4 credentials instead of environment variables
2. **Implement token caching** in Lambda to reduce OIDC provider calls
3. **Add CloudWatch metrics** for authentication failures and performance
4. **Use Lambda Layers** for shared OIDC validation code
5. **Implement token expiration** handling in frontend
6. **Enable API logging** for audit trail of authentication events

---

**Document Version**: 1.0  
**Last Updated**: November 17, 2025  
**Prepared By**: Code Analysis System  
**Next Review**: Upon IdentityServer4 implementation

